# Magnetic Pendulum Fractal Generator (Rust)

这是一个基于 Rust 编写的高性能磁性摆分形生成器。该程序模拟了一个金属摆球在多个磁铁作用下的混沌运动轨迹，并根据摆球最终停留在哪个磁铁上方，绘制出色彩斑斓的分形图像（Magnet Pendulum Fractal）。

项目利用 **Rayon** 进行多线程并行计算，并实现了 **Runge-Kutta 4 (RK4)** 数值积分与 **李雅普诺夫（Lyapunov）能量判定** 算法，以极大地优化模拟效率。

## ✨ 核心特性

* **双物理模式支持**：
* **SmallAngle (小角近似)**：适用于模拟经典的线性回复力模型，默认摆动平面设为 。
* **Rigour (严格模式)**：基于真实物理约束，将二维像素点逆向投影到三维球面上，精确模拟刚性杆摆动。


* **高性能数值计算**：
* 使用泛型实现的 **RK4 (Runge-Kutta 4)** 积分器。
* 基于 **Rayon** 的并行迭代器，充分利用多核 CPU 渲染图像。


* **智能模拟终止 (Lyapunov Optimization)**：
* 不仅依赖物理碰撞检测，还预计算了每个磁铁的“逃逸能量阈值”。
* 一旦摆球进入磁铁势阱且总能量低于逃逸阈值，程序将提前判定捕获，无需等待速度完全衰减。


* **高度可配置**：通过 JSON 文件动态调整磁铁布局、摆球参数和物理模式。

---

## 🧮 物理模型与数学原理

系统模拟了一个受重力、磁力和空气阻力作用的摆球。

### 1. 受力分析

对于位置  和速度 ，摆球受到的合力  计算如下：

* **重力/回复力 ()**：
* *SmallAngle*: 近似为胡克定律 ，其中 。
* *Rigour*: 真实的重力向量 。


* **磁力 ()**：
假设磁铁为磁单极子模型（或远场近似），力的大小与距离的立方成反比：



其中  为磁场强度， 为距离。
* **阻力 ()**：
线性阻尼 ，用于耗散能量使系统收敛。

### 2. 几何约束 (Rigour Mode)

在严格模式下，程序通过几何修正消除数值漂移，强制摆球位于以悬挂点为球心的球面上：

1. **初始化投影**：将 2D 像素坐标  投影到球面：



(程序中包含逻辑处理  的无效区域)
2. **步进修正**：每一步 RK4 计算后，将位置向量拉回绳长  处，并移除沿绳方向的速度分量。

---

## 🛠️ 代码架构概览

| 模块文件 | 功能描述 |
| --- | --- |
| `main.rs` | **程序入口**。负责图像缓冲区分配、Rayon 并行渲染循环、初始坐标投影（2D转3D）以及最终图像保存。 |
| `simulation.rs` | **模拟控制回路**。执行单点的物理演化，包含边界检查、物理碰撞检测和能量捕获判定。 |
| `derivative.rs` | **物理方程**。实现了 `OdeSystem` 特征，定义了上述的受力分析和导数计算。 |
| `RK4.rs` | **数值积分器**。通用的四阶龙格-库塔求解器，支持任何实现了 `VectorSpace` 的状态类型。 |
| `lyapunov_function.rs` | **能量分析模块**。计算动能、势能，并预计算磁铁的逃逸能量（鞍点能量）以加速收敛判定。 |
| `structs.rs` | 基础数据结构，如 `Vector3D` 及其运算符重载。 |
| `physicial_structs.rs` | 定义配置文件的序列化结构 (`Magnet`, `PendulumInfo`)。 |

---

## 🚀 优化技术详解

### 1. 李雅普诺夫能量判定 (Energy Trap)

为了避免模拟陷入漫长的微小震荡，程序引入了能量判定机制：

* **预计算**：在模拟开始前，计算每对磁铁连线上的势能最大值（势垒/鞍点）。对于每个磁铁，其“逃逸阈值”是它周围最低的势垒高度。
* **运行时检查**：当摆球进入磁铁的 `basin_radius` 且总能量  小于该磁铁的逃逸阈值时，物理上它已无法逃离该势阱。程序直接判定捕获。

### 2. 并行渲染 (Rayon)

图像生成的每个像素计算是相互独立的。`main.rs` 使用 `img_buffer.par_chunks_exact_mut(3)` 将像素数据切片，利用 Rust 的 Rayon 库自动将任务分发到所有 CPU 核心。

---

## ⚙️ 配置文件 (config.json)

在运行前，请确保目录下存在 `config.json`。格式如下：

```json
{
  "pendulum": {
    "suspension_point": { "x": 0.0, "y": 0.0, "z": 2.0 },
    "mass": 1.0,
    "approximate": "Rigour" 
  },
  "magnets": [
    {
      "position": { "x": 1.0, "y": 0.0, "z": 0.0 },
      "velocity": { "x": 0.0, "y": 0.0, "z": 0.0 },
      "direction": "Positive",
      "strength": 5.0
    },
    {
      "position": { "x": -0.5, "y": 0.866, "z": 0.0 },
      "velocity": { "x": 0.0, "y": 0.0, "z": 0.0 },
      "direction": "Positive",
      "strength": 5.0
    },
    {
      "position": { "x": -0.5, "y": -0.866, "z": 0.0 },
      "velocity": { "x": 0.0, "y": 0.0, "z": 0.0 },
      "direction": "Positive",
      "strength": 5.0
    }
  ]
}

```

* **approximate**: 可选 `"SmallAngle"` 或 `"Rigour"`。
* **direction**: `"Positive"` (吸引) 或 `"Negative"` (排斥)。

---

## 📦 构建与运行

确保已安装 Rust 工具链。

1. **编译并优化** (推荐使用 release 模式以获得最佳性能):
```bash
cargo build --release

```


2. **运行**:
```bash
cargo run --release

```


3. **输出**:
程序运行结束后，将在根目录生成 `magnetic_fractal.png`。控制台会显示进度条、物理边界范围以及预计算的能量阈值。

---

## 📝 关键参数说明 (Hardcoded in main.rs)

部分模拟参数为了性能硬编码在源码中，可根据需要修改：

* `WIDTH / HEIGHT`: 输出图像分辨率 (默认 3000 x 3000)。
* `friction`: 阻尼系数 (默认 0.01，越小图像越混沌)。
* `sim_config.max_steps`: 最大迭代步数 (默认 3000)。
* `sim_config.time_step`: 时间步长  (默认 0.01)。
* `sim_config.basin_radius`: 能量判定半径 (默认 2.0)。
